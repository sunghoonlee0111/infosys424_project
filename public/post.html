<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <title>Habitat for Humanity</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Covered+By+Your+Grace&family=Manrope:wght@200..800&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- header -->
    <header>
      <div class="header max_width_1920">
        <!-- navbar -->
        <nav class="navbar" role="navigation" aria-label="main navigation">
          <div class="navbar-brand">
            <a href="index.html" class="nav_logo"></a>
            <a
              role="button"
              class="navbar-burger"
              id="burger_nav"
              aria-label="menu"
              aria-expanded="false"
              data-target="navbarBasicExample"
            >
              <span aria-hidden="true"></span>
              <span aria-hidden="true"></span>
              <span aria-hidden="true"></span>
            </a>
          </div>
          <div class="navbar-menu" id="menu_nav">
            <div class="navbar-start">
              <a href="index.html" class="navbar-item">HOME</a>
              <a href="about.html" class="navbar-item">ABOUT</a>
              <a href="gallery.html" class="navbar-item">GALLERY</a>
              <a href="post.html" class="navbar-item">POST</a>
              <a href="event.html" class="navbar-item">EVENT</a>
            </div>
            <div class="navbar-end">
              <div class="nav_signin navbar-item">
                <button
                  class="button has-text-black is-rounded"
                  id="user_signin"
                >
                  Sign In
                </button>
              </div>
              <div class="navbar-item">
                <button
                  class="nav_signup button has-text-black is-rounded main-color"
                  id="user_signup"
                >
                  Sign Up
                </button>
              </div>
            </div>
          </div>
        </nav>
        <!-- banner -->
        <img class="index_banner" src="image/Banner.png" alt="Banner Image" />
      </div>
    </header>
    <main class="max_width_1200">
      <!-- post -->
      <div class="post_main">
        <!-- post title -->
        <div class="post_title">
          <p>POST</p>
        </div>
        <!-- post container -->
        <div id="post_container"></div>
      </div>
    </main>

    <!-- footer -->
    <footer class="max_width_1920">
      <div class="footer_content max_width_1200">
        <!-- footer logo -->
        <div class="footer_logo_and_icons">
          <img
            class="footer_logo_photo"
            src="image/logos/Footer_logo.png"
            alt="footer logo"
          />
          <p class="footer_icons">
            <a href="https://www.facebook.com/HabitatUW">FB</a>
            <a href="https://www.instagram.com/h4huw/">IG</a>
            <a href="">TW</a>
            <a href="https://linktr.ee/h4huw">LT</a>
          </p>
        </div>
        <!-- footer contents -->
        <div class="footer_contents">
          <p>
            Humanity Campus Chapter at the University of Wisconsin â€“ Madison
          </p>
          <p>666 Langdon St, Madison WI 53703</p>

          <p>
            <a href="mailto:absed@gmail.com">absed@gmail.com</a>
            <span class="footer_policy">000-000-0000</span>
          </p>

          <p>
            <span><a href="#" class="footer_a_tag">Term of Use</a></span>
            <span class="footer_policy"
              ><a href="#" class="footer_a_tag">Privacy Policy</a></span
            >
          </p>
        </div>
      </div>
    </footer>
  </body>

  <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>

  <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>

  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>

  <script type="module">
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAq-CkeNE_K765pauvvO-72oAUIGCE_Jpc",
      authDomain: "hfh-uwmadison.firebaseapp.com",
      projectId: "hfh-uwmadison",
      storageBucket: "hfh-uwmadison.appspot.com",
      messagingSenderId: "158190324248",
      appId: "1:158190324248:web:89397ab7a4171eb54e516d",
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let postsContainer = document.querySelector("#post_container");
      let defaultThumbnail = "image/Banner.png"; // Default thumbnail if no image found

      // Function to limit the number of words in the excerpt
      function createExcerpt(content, wordLimit) {
        let words = content.split(" ");
        if (words.length > wordLimit) {
          return words.slice(0, wordLimit).join(" ") + "...";
        }
        return content;
      }

      // Function to extract the first image from the Delta object
      function getFirstImageFromDelta(delta) {
        const ops = JSON.parse(delta).ops;
        //console.log(ops);
        const imgOp = ops.find((op) => op.insert.image);
        if (imgOp != null) {
          return imgOp.insert.image;
        } else {
          return defaultThumbnail;
        }
      }

      // Fetch posts from Firestore
      firebase
        .firestore()
        .collection("posts")
        .orderBy("timestamp", "desc")
        .get()
        .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            let doc_id = doc.id;

            // console.log(doc.id, " => ", doc.data());
            let postData = doc.data();

            //Get the first image from the content
            let postThumbnailSrc = getFirstImageFromDelta(postData.content);

            //Get post username and post time information
            let postUsername = postData.username || "Anonymous";
            var postTime = new Date(postData.timestamp.seconds * 1000);

            postTime = postTime.toLocaleString("en-US");

            //Get the post title and content information
            let postTitle = postData.title;
            let postContent = postData.contentText;

            //Create the post element
            let html = `<div class="post_content_box">`;

            html += `<!-- thumbnail -->
          <img
            class="post_thumbnail"
            src="${postThumbnailSrc}"
            alt="Post Thumbnail"
          />
          <!-- texts -->
          <div class="post_texts">
            <!-- username and date -->
            <div class="post_nameanddate">
              <div class="post_username">${postUsername}</div>
              <div class="post_time">${postTime}</div>
            </div>
            <!-- title and texts -->
            <span class="post_text_title">
              <a  value = ${doc_id} class = "to_post_detail">${postTitle}</a></span
            >
            <p class="post_text">
              ${createExcerpt(postContent, 30)}
            </p>
            <span class="post_readmore">
              <a value = ${doc_id} class = "to_post_detail">Read More</a>
            </span>
          </div>`;
            html += `</div>`;

            postsContainer.innerHTML += html;
          });

          //function to navigate to inside_post with assigned doc id when the post is clicked
          function navigateToInsidePost(doc_id) {
            console.log(doc_id);
          }

          //add click event listener to right buttons with class name "to_post_detail"

          document.querySelectorAll(".to_post_detail").forEach((button) => {
            button.addEventListener("click", (e) => {
              //avtivate function navigateToInsidePost with assigned doc id
              navigateToInsidePost(e.target.getAttribute("value"));
            });
          });
        })
        .catch((error) => {
          console.log("Error getting documents: ", error);
        });
    });
  </script>

  <script src="app.js"></script>
</html>
